import React, { useEffect, useRef, useState } from 'react';
import { Alert, Button, DatePicker, Input, InputNumber, Select, TimePicker } from 'antd';
import '../../styles/Group/GroupCreate.css'
import DaumPostcode from "react-daum-postcode";
import DaumAddressPopup from './DaumPostCode/DaumAddressPopup';
import NavigatorTop from '../Navigator/NavigatorTop';
import { Outlet, useNavigate } from 'react-router-dom';
import NavigatorMain from '../Navigator/NavigatorMain';
import TextArea from 'antd/es/input/TextArea';
import styled from 'styled-components';
import { GrLocation } from 'react-icons/gr';
import { BiCart, BiHighlight, BiUser } from 'react-icons/bi'
import { MdAttachMoney } from 'react-icons/md';
import axios from 'axios';
const format = 'HH:mm';

const CreateCenter = styled.div`
  text-align: center;
`

function GroupCreate({
  getGroupList
}) {
  const navigate = useNavigate();

  const [errorMessage, setErrorMessage] = useState();
  const [isPopupOpen, setIsPopupOpen] = useState(false);
  const [priceToggle, setPriceToggle] = useState(false);

  const [groupTitle, setGroupTitle] = useState('');
  const [groupUser, setGroupUser] = useState(window.sessionStorage.getItem(`userID`));
  const [groupLocation, setGroupLocation] = useState('');
  const [groupArticle, setGroupArticle] = useState('');
  const [groupDate, setGroupDate] = useState('');
  const [groupTime, setGroupTime] = useState('');
  const [groupPrice, setGroupPrice] = useState();
  const [groupMax, setGroupMax] = useState();
  const [groupCategory, setGroupCategory] = useState();
  const [groupTradeType, setGroupTradeType] = useState('');
  const [groupProduct, setGroupProduct] = useState('');

  const titleRef = useRef();
  const locationRef = useRef();
  const articleRef = useRef();
  const dateRef = useRef();
  const timeRef = useRef();
  const priceRef = useRef();
  const maxRef = useRef();
  const categoryRef = useRef();
  const tradeTypeRef = useRef('');
  const productRef = useRef('');

  console.log(
    typeof (groupTitle), '/',
    typeof (groupUser), '/',
    typeof (groupLocation), '/',
    typeof (groupArticle), '/',
    typeof (groupDate), '/',
    typeof (groupTime), '/',
    typeof (groupPrice), '/',
    typeof (groupCategory), '/',
    typeof (groupTradeType), '/',
    typeof (groupProduct), '/',
    typeof (groupMax)
  );

  console.log(
    groupTitle, '/',
    groupUser, '/',
    groupLocation, '/',
    groupArticle, '/',
    groupDate, '/',
    groupTime, '/',
    groupPrice, '/',
    groupCategory, '/',
    groupTradeType, '/',
    groupProduct, '/',
    groupMax
  );

  console.log(priceToggle);

  function createGroup() {
    axios
      .post('http://localhost:8088/nadoo/createTrade', {
        tradeTitle: groupTitle,
        tradeAddress: groupLocation,
        tradeContent: groupArticle,
        userAccount: groupUser,
        tradeEndtime: groupDate + ' ' + groupTime,
        tradePrice: `${groupPrice}`,
        tradeMax: groupMax,
        tradeType: groupTradeType,
        categoryIdx: groupCategory,
        tradeProduct: groupProduct
      })
      .then(
        async (res) => {
          await getGroupList();
          await navigate('/grouplist');
        })
      .catch((e) => {
        console.error(e);
      })
  };

  const errorCheck = () => {
    if (groupTradeType === '' || groupTradeType === undefined) {
      setErrorMessage(
        <Alert
          message="ÎÇòÎëêÏùò Í±∞Îûò Ï¢ÖÎ•òÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      tradeTypeRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      categoryRef.current.focus();
    }

    if (groupCategory === null || groupCategory === undefined) {
      setErrorMessage(
        <Alert
          message="ÎÇòÎëêÏùò Í±∞Îûò Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      categoryRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      titleRef.current.focus();
    }

    if (groupTitle === '' || groupTitle === undefined) {
      setErrorMessage(
        <Alert
          message="ÎÇòÎëêÏùò Ï†úÎ™©ÏùÑ ÏßÄÏñ¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      titleRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      productRef.current.focus();
    }

    if (groupProduct === '' || groupProduct === undefined) {
      setErrorMessage(
        <Alert
          message="ÌåêÎß§Ìï† Î¨ºÌíàÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      productRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      if (priceToggle === false) {
        priceRef.current.focus();
      }
    }

    if ((groupPrice === '' || groupPrice === undefined) && priceToggle === false) {
      setErrorMessage(
        <Alert
          message="ÌåêÎß§Ìï† Î¨ºÌíàÏùò Í∞ÄÍ≤©ÏùÑ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      priceRef.current.focus();
      return false;
    } else if (groupPrice === 0) {
      setErrorMessage("");
      locationRef.current.focus();
    }

    if (groupMax === '' || groupMax === undefined) {
      setErrorMessage(
        <Alert
          message="Í±∞ÎûòÌï† Ïù∏ÏõêÏùÑ Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      maxRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      dateRef.current.focus();
    }

    if (groupDate === '' || groupDate === undefined) {
      setErrorMessage(
        <Alert
          message="ÎÇòÎëêÍ∞Ä ÎÅùÎÇòÎäî ÎÇ†ÏßúÎ•º Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      dateRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      timeRef.current.focus();
    }

    if (groupTime === '' || groupTime === undefined) {
      setErrorMessage(
        <Alert
          message="ÎÇòÎëêÍ∞Ä ÎÅùÎÇòÎäî ÏãúÍ∞ÑÏùÑ Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      timeRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      locationRef.current.focus();
    }

    if (groupLocation === '' || groupLocation === undefined) {
      setErrorMessage(
        <Alert
          message="ÎÇòÎëêÏùò ÏúÑÏπòÎ•º ÏïåÎ†§Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      locationRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
      articleRef.current.focus();
    }

    if (groupArticle === '' || groupArticle === undefined) {
      setErrorMessage(
        <Alert
          message="Ï†ÑÌïòÍ≥† Ïã∂ÏùÄ Î©îÏÑ∏ÏßÄÎ•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!"
          type="error"
          showIcon
          style={{
            width: '90%',
            margin: `0 auto`
          }}
        />
      );
      articleRef.current.focus();
      return false;
    } else {
      setErrorMessage("");
    }

    createGroup();
  }

  /** ÌåùÏóÖÏ∞Ω Ïó¥Í∏∞ */
  const openPostCode = () => {
    setIsPopupOpen(true);
  };

  /** ÌåùÏóÖÏ∞Ω Îã´Í∏∞ */
  const closePostCode = () => {
    setIsPopupOpen(false);
  };

  const handlePostCode = (data) => {
    let fullAddress = data.address;
    let extraAddress = "";

    if (data.addressType === "R") {
      if (data.bname !== "") {
        extraAddress += data.bname;
      }
      if (data.buildingName !== "") {
        extraAddress +=
          extraAddress !== "" ? `, ${data.buildingName}` : data.buildingName;
      }
      fullAddress += extraAddress !== "" ? ` (${extraAddress})` : "";
    }
    locationRef.current.value = fullAddress;
    setGroupLocation(fullAddress);
    closePostCode();
  };

  return (
    <>
      <NavigatorTop />
      <Outlet />
      <CreateCenter>
        <p className='GroupCreate_title'>
          üëã ÎÇòÎëêÎ•º ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî! üëã
          {/* üö®‚è∞‚ùó */}
        </p>
        <div className='GroupCreate_select'>
          <Select
            defaultValue="Í±∞Îûò Ï¢ÖÎ•ò"
            style={{
              width: '48%',
              marginRight: '2%'
            }}
            options={[
              {
                value: 'ÏùºÎ∞òÍ±∞Îûò',
                label: 'ÏùºÎ∞ò Í±∞Îûò',
              },
              {
                value: 'Î≤àÍ∞úÍ±∞Îûò',
                label: 'Î≤àÍ∞ú Í±∞Îûò',
              }
            ]}
            onChange={
              (value) => {
                setGroupTradeType(value);
              }}
            ref={tradeTypeRef}
          />
          <Select
            defaultValue="Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù"
            style={{
              width: '48%',
              marginLeft: '2%'
            }}
            options={[
              {
                value: '1',
                label: 'Î∑∞Ìã∞',
              },
              {
                value: '2',
                label: 'ÏãùÎ£åÌíà',
              },
              {
                value: '3',
                label: 'ÏÉùÌïÑÌíà',
              }
            ]}
            onChange={
              (value) => {
                setGroupCategory(value);
              }}
            ref={categoryRef}
          />
        </div>
        <br />
        <br />
        <Input
          placeholder="ÎÇòÎëêÏùò Ïù¥Î¶ÑÏùÄ Î¨¥ÏóáÏúºÎ°ú Ìï†ÍπåÏöî?"
          style={{
            width: '90%'
          }}
          prefix={<BiHighlight className="site-form-item-icon" />}
          ref={titleRef}
          onChange={(e) => {
            setGroupTitle(e.target.value);
          }}
        />
        <br />
        <br />
        <Input
          placeholder="ÌåêÎß§Ìï† Î¨ºÌíàÏùÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?"
          style={{
            width: '90%'
          }}
          prefix={<BiCart className="site-form-item-icon" />}
          ref={productRef}
          onChange={(e) => {
            setGroupProduct(e.target.value);
          }}
        />
        {
          priceToggle === true ?
            ''
            :
            <>
              <br />
              <br />
              <Input
                type='number'
                placeholder="ÌåêÎß§Ìï† Î¨ºÌíàÏùò Í∞ÄÍ≤©ÏùÑ Îß§Í≤®Ï£ºÏÑ∏Ïöî."
                style={{
                  width: '90%'
                }}
                prefix={<MdAttachMoney className="site-form-item-icon" />}
                ref={priceRef}
                onChange={(e) => {
                  setGroupPrice(e.target.value);
                }}
              />
            </>
        }
        <br />
        <br />
        <Button
          style={{
            width: '90%'
          }}
          type="dashed"
          onClick={
            () => {
              setPriceToggle(!priceToggle);
              if (priceToggle === false) {
                setGroupPrice(0);
              } else if (priceToggle === true) {
                setGroupPrice('');
              }
            }
          }
        >
          {
            priceToggle === true ?
              'Í∞ÄÍ≤©ÏùÑ Ï†ïÌïòÍ≥† Ïã∂Ïñ¥Ïöî!'
              :
              'ÎßåÎÇòÏÑú Í≤∞Ï†ïÌïòÍ≥† Ïã∂Ïñ¥Ïöî!'
          }
        </Button>
        <br />
        <br />
        <Input
          placeholder="Î™á Î™ÖÍ≥º Í±∞ÎûòÎ•º ÌïòÍ≥† Ïã∂ÏúºÏã†Í∞ÄÏöî?"
          type='number'
          style={{
            width: '90%'
          }}
          prefix={<BiUser className="site-form-item-icon" />}
          ref={maxRef}
          onChange={(e) => {
            setGroupMax(e.target.value);
          }}
        />
        <br />
        <br />
        <div className='GroupCreate_select'>
          <DatePicker
            placeholder='ÎÇ†ÏßúÎ•º Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.'
            style={{
              width: '48%',
              marginRight: '2%'
            }}
            onChange={
              (date, dateString) => {
                setGroupDate(dateString);
              }}
            size="large"
            ref={dateRef}
          />
          <TimePicker
            style={{
              width: '48%',
              marginLeft: '2%'
            }}
            placeholder='ÏãúÍ∞ÑÏùÑ Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.'
            format={format}
            size="large"
            onChange={
              (time, timeSting) => {
                setGroupTime(timeSting);
              }
            }
            ref={timeRef}
          />
        </div>
        <br />
        <br />
        <Input
          type="text"
          placeholder="ÏúÑÏπòÎäî Ïñ¥ÎîîÎ°ú Ìï†ÍπåÏöî?"
          style={{
            width: '90%'
          }}
          ref={locationRef}
          value={groupLocation}
          onClick={() => {
            openPostCode();
            locationRef.current.value = '';
          }}
          onChange={() => {
            openPostCode();
            setGroupLocation(locationRef.current.value);
          }}
          prefix={<GrLocation className="site-form-item-icon" />}
        />
        {/* ÌåùÏóÖ ÏÉùÏÑ± Í∏∞Ï§Ä div */}
        <div id="popupDom">
          <br />
          {isPopupOpen && (
            <DaumAddressPopup>
              <div>
                <DaumPostcode onComplete={handlePostCode} />
                {/* Îã´Í∏∞ Î≤ÑÌäº ÏÉùÏÑ± */}
                <button
                  type="button"
                  onClick={() => {
                    closePostCode();
                  }}
                  className="GroupCreate_button"
                >
                  Îã´Í∏∞
                </button>
              </div>
            </DaumAddressPopup>
          )}
        </div>
        <TextArea
          showCount
          maxLength={200}
          style={{
            height: 160,
            resize: 'none',
            width: '90%'
          }}
          placeholder="Ï†ÑÌïòÍ≥† Ïã∂ÏùÄ Î©îÏãúÏßÄÎ•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!"
          ref={articleRef}
          onChange={(e) => {
            setGroupArticle(e.target.value);
          }}
        />
        <br />
        <br />
        {errorMessage}
        <br />
        <Button
          type="primary"
          onClick={
            () => {
              errorCheck();
            }
          }
        >
          ÎÇòÎëê ÎßåÎì§Í∏∞
        </Button>
      </CreateCenter>
      <NavigatorMain />
      <Outlet />
    </>
  );
}

export default GroupCreate;